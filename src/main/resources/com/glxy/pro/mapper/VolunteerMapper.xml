<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.glxy.pro.mapper.VolunteerMapper">

    <select id="getVolunteerById" resultType="com.glxy.pro.bo.VolunteerBo">
        select v.stu_id     as stuId,
               v.major_id   as majorId,
               m.major_name as majorName,
               v.which      as which
        from volunteer v
                 left join major m using (major_id)
        where stu_id = #{stuId}
        order by which;
    </select>

    <delete id="removeBatchByStuIds">
        DELETE FROM volunteer
        WHERE stu_id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </delete>

    <select id="getUnFillStuByCateId" resultType="com.glxy.pro.bo.StudentBo">
        SELECT s.stu_id        AS stuId,
               s.stu_name      AS name,
               s.stu_sex       AS sex,
               CASE s.stu_sex
                   WHEN 0 THEN '男'
                   WHEN 1 THEN '女'
                   END         AS sexString,
               s.stu_grade     AS grade,
               s.category_id   AS categoryId,
               c.category_name AS category,
               s.stu_class     AS stuClass,
               s.stu_score     AS score
        FROM student s,
             category c
        WHERE NOT EXISTS(SELECT stu_id
                         FROM volunteer v
                         WHERE s.stu_id = v.stu_id)
          AND s.category_id = c.category_id;
    </select>

    <select id="getFillCountByCateId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM student s
        WHERE EXISTS(SELECT stu_id
                     FROM volunteer v
                     WHERE s.stu_id = v.stu_id);
    </select>

    <select id="getVolunteerByPagesAndConditions" resultType="com.glxy.pro.DTO.VolunteerDTO">
        SELECT
        s.stu_id AS stuId,
        s.stu_name AS name,
        s.stu_grade AS grade,
        c.category_name AS category,
        s.stu_class AS stuClass,
        v.which AS which,
        m.major_name AS majorName
        FROM student s
        LEFT JOIN category c USING (category_id)
        LEFT JOIN volunteer v USING (stu_id)
        LEFT JOIN major m USING (major_id)
        <where>
            <if test="query.categoryId != null and query.categoryId != '' ">
                AND s.category_id = #{query.categoryId}
            </if>
            <if test="query.name != null and query.name != '' ">
                AND s.stu_name LIKE "%"#{query.name}"%"
            </if>
            <if test="query.majorName != null and query.majorName != ''">
                AND m.major_name = #{query.majorName}
            </if>
            <if test="query.grade != null and query.grade != '' ">
                AND s.stu_grade = #{query.grade}
            </if>
            <if test="query.stuIds != null">
                AND s.stu_id IN
                <foreach collection="query.stuIds" item="id" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
        </where>
        ORDER BY s.stu_id ASC, v.which ASC
        LIMIT #{begin}, #{query.pageSize}
    </select>
</mapper>
